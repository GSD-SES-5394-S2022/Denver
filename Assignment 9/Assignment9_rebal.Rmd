---
title: "Assignment9_rebalance"
output: html_document
date: '2022-04-05'
---
# Load Libraries

```{r}
	library(here)
	library(tidyverse)
	library(sf)
	library(knitr)
	library(kableExtra)
	library(survey)
	library(srvyr)
```
	
# Calculating Cost Variables
	
## Transit fare per unlinked trip
	
We looked at the transit agency profile for RTD. We see that the annual fare revenue (in the year 2020) is $76,264,572 and the annual number of unlinked trips is 52,314,687.
	

```{r}
	cost_per_ride <- 76264572/52314687
	
	cost_per_ride
```
Our typical fare is $1.457804
	

## Driving Cost Per Minute
```{r}
	temp <- tempfile()
	download.file("https://nhts.ornl.gov/assets/2016/download/csv.zip", temp)
	
	vehs <- read_csv(unz(temp, "vehpub.csv"), 
	                 show_col_types = FALSE) %>%
	  filter(HH_CBSA == "19740")
	
	trips <- read_csv(unz(temp, "trippub.csv"), 
	                      show_col_types = FALSE) %>%
	  filter(HH_CBSA == "19740")
	
	car_trips <- trips %>%
	  filter(PSGR_FLG == "02") 
	  
	unlink(temp)
```

	Then we create a survey object for both of these tables. The weights are for estimating annual trips. 
	
```{r}
	car_trips_svy <- car_trips %>%
	  as_survey(weights = WTTRDFIN)
	
	veh_svy <- vehs %>%
	  as_survey(weights = WTHHFIN)
```
Then we calculate the total annual time spent driving cars and the total fuel expenditure across the region. 
	
```{r}
	total_time <- car_trips_svy %>%
	  summarise(total_time = survey_total(TRVLCMIN))
	
	kable(total_time, format.args = list(big.mark = ",",
	                                     scientific = FALSE))
```
Households in Denver spend a total of about 44 billion minutes driving in cars annually. The region's population is close to 2.8 million.
	
```{r}
	total_gas_cost <- veh_svy %>%
	  summarise(total_cost = survey_total(GSTOTCST))
	
	kable(total_gas_cost, format.args = list(big.mark = ","))
```
	
Figuring out costs per minute:
	

```{r}
	cost_per_minute <- total_gas_cost$total_cost[1] / total_time$total_time[1] 
	
	cost_per_minute
```
	
Denver households spend about 5.4 cents per minute to operate a car. 
	

## Costs per trip 
We first load the skims from assignment 4. 
	
```{r}
	skims <- here("existing",
	              "data",
	              "ex_skims_update.csv") %>%
	  read_csv(show_col_types = FALSE)
	
	skims <- skims %>%
	  mutate(bike_time = bicycle_time)
	
	alt_skims <- here("alternative",
	              "data",
	              "alt_skims_update.csv") %>%
	  read_csv(show_col_types = FALSE)
	
	alt_skims <- alt_skims %>%
	  mutate(bike_time = bicycle_time)
	
	head(skims, 5) %>%
	  kable() %>%
	  kable_styling() %>%
	  scroll_box(width = "500px", height = "320px")
```
	
We then add the cost of transit and driving to the skims. 
	
```{r}
	skims <- skims %>%
	  mutate(drive_cost = car_time * cost_per_minute) %>%
	  mutate(transit_cost = n_rides * cost_per_ride)
```
We can determine the cost of carpooling by dividing the cost of driving among all occupants in the car. The NCHRP 716 indicates that for HBW trips the average vehicle occupance of 2+ carpools is 2.42. 
	
```{r}
	skims <- skims %>%
	  mutate(carpool_cost = drive_cost / 2.42)
```
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(drive_cost = car_time * cost_per_minute) %>%
	  mutate(transit_cost = n_rides * cost_per_ride)
```
	
We can determine the cost of carpooling by dividing the cost of driving among all occupants in the car. The NCHRP 716 indicates that for HBW trips the average vehicle occupance of 2+ carpools is 2.42. 
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(carpool_cost = drive_cost / 2.42)
```
# Estimate existing mode shares
	
Our mode choice model is calibrated to the existing regional mode shares. This means we need to calculate the overall mode share for each of our three trip purposes. 
	
```{r}
	trips <- trips %>%
	  mutate(home_based = case_when(WHYTO == "01" ~ TRUE,
	                                WHYTO == "02" ~ TRUE,
	                                WHYFROM == "01" ~ TRUE,
	                                WHYFROM == "02" ~ TRUE,
	                                TRUE ~ FALSE)) %>%
	  mutate(work = ifelse(WHYTO == "03" | WHYFROM == "03", TRUE, FALSE)) %>%
	  mutate(purpose = case_when(home_based & work ~ "HBW",
	                            home_based ~ "HBO",
	                            TRUE ~ "NHB")) %>%
	  mutate(mode = case_when(TRPTRANS == "01" ~ "walk",
	                          TRPTRANS == "02" ~ "bike",
	                          TRPTRANS == "03" & NUMONTRP > 1 ~ "HOV",
	                          TRPTRANS == "04" & NUMONTRP > 1 ~ "HOV",
	                          TRPTRANS == "05" & NUMONTRP > 1 ~ "HOV",
	                          TRPTRANS == "06" & NUMONTRP > 1 ~ "HOV",
	                          TRPTRANS == "08" & NUMONTRP > 1 ~ "HOV",
	                          TRPTRANS == "17" & NUMONTRP > 1 ~ "HOV",
	                          TRPTRANS == "18" & NUMONTRP > 1 ~ "HOV",
	                          TRPTRANS == "03" ~ "SOV",
	                          TRPTRANS == "04" ~ "SOV",
	                          TRPTRANS == "05" ~ "SOV",
	                          TRPTRANS == "06" ~ "SOV",
	                          TRPTRANS == "08" ~ "SOV",
	                          TRPTRANS == "17" ~ "SOV",
	                          TRPTRANS == "18" ~ "SOV",
	                          TRPTRANS == "10" ~ "transit",
	                          TRPTRANS == "11" ~ "transit",
	                          TRPTRANS == "12" ~ "transit",
	                          TRPTRANS == "13" ~ "transit",
	                          TRPTRANS == "16" ~ "transit",
	                          TRUE ~ "other")) %>%
	  filter(mode != "other")
```
We can then create a survey object and use it to generate the number of trips by mode. 
	
```{r}
	trips_svy <- trips %>%
	  as_survey(weights = WTTRDFIN)
	
	mode_by_purpose <- trips_svy %>%
	  group_by(purpose, mode) %>%
	  survey_tally() %>%
	  select(-n_se) %>%
	  pivot_wider(names_from = mode,
	              values_from = n,
	              names_prefix = "n_",) %>%
	  mutate(n_trips = n_bike + n_SOV + n_HOV + n_transit + n_walk) %>%
	  mutate(pct_bike = n_bike / n_trips) %>%
	  mutate(pct_SOV = n_SOV / n_trips) %>%
	  mutate(pct_HOV = n_HOV / n_trips) %>%
	  mutate(pct_walk = n_walk / n_trips) %>%
	  mutate(pct_transit = n_transit / n_trips) %>%
	  select(purpose, pct_bike, pct_SOV, pct_HOV, pct_transit, pct_walk)
	
	mode_by_purpose
```
	
# Selecting a model
	
For HBW trips, we will use Model H. The coefficients are below. 
	In-vehicle time: -0.033
	Walk time: -0.093
	First wait time: -0.038
	Transfer wait time: -0.038
	Cost: -0.0021
	
For HBO trips, we will use Model I. The coefficients are below. 
	In-vehicle time: -0.008
	Out-of vehicle time: -0.025
	Auto operating cost: -0.010
	Parking cost: -0.025
	Transit cost: -0.010

For NHB trips, we will use Model M. The coefficients are below: 
	In-vehicle time: -0.013
	Walk time: -0.032
	First wait time: -0.032
	Transfer wait time: -0.050
	Cost: -0.002
	
# Apply a selected mode-choice model
	
## HBO
	
### Calculate mode-specific constants (HBO)
	
```{r}
	SOV_share_HBO <- mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBO"]
	HOV_share_HBO <- mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBO"]
	transit_share_HBO <- mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBO"]
	walk_share_HBO <- mode_by_purpose$pct_walk[mode_by_purpose$purpose == "HBO"]
	bike_share_HBO <- mode_by_purpose$pct_bike[mode_by_purpose$purpose == "HBO"]
	
	SOV_const_HBO <- log(SOV_share_HBO / (1 - SOV_share_HBO))
	HOV_const_HBO <- log(HOV_share_HBO / (1 - HOV_share_HBO))
	transit_const_HBO <- log(transit_share_HBO / (1 - transit_share_HBO))
	walk_const_HBO <- log(walk_share_HBO / (1 - walk_share_HBO))
	bike_const_HBO <- log(bike_share_HBO / (1 - bike_share_HBO))
```
	
### Estimate utility of each mode (HBO)
	
Here is where we apply the coefficients from our model above. 
	
```{r}
	skims <- skims %>%
	  mutate(utility_transit_HBO = transit_const_HBO +
	                               ride_time * -0.008  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.025 +
	                               transit_cost * -0.01,
	         utility_SOV_HBO = SOV_const_HBO +
	                           car_time * -0.008 +
	                           drive_cost * -0.01,
	         utility_HOV_HBO = HOV_const_HBO +
	                           car_time * -0.008 +
	                           carpool_cost * -0.01,
	         utility_walk_HBO = walk_const_HBO +
	                            walk_time * -0.025,
	         utility_bike_HBO = bike_const_HBO +
	                            bike_time * -0.025) %>%
	  mutate(exp_u_walk_HBO = exp(utility_walk_HBO),
	         exp_u_bike_HBO = exp(utility_bike_HBO),
	         exp_u_SOV_HBO = exp(utility_SOV_HBO),
	         exp_u_HOV_HBO = exp(utility_HOV_HBO),
	         exp_u_transit_HBO = exp(utility_transit_HBO)) %>%
	  rowwise() %>%
	  mutate(utility_active_HBO = log(sum(exp_u_walk_HBO, 
	                                          exp_u_bike_HBO, 
	                                          na.rm = TRUE)),
	         utility_car_HBO = log(sum(exp_u_SOV_HBO,
	                                       exp_u_HOV_HBO,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_HBO = exp(utility_active_HBO),
	         exp_u_car_HBO = exp(utility_car_HBO)) %>%
	  mutate(total_utility_HBO = sum(exp_u_active_HBO, 
	                                 exp_u_car_HBO,
	                                 exp_u_transit_HBO,
	                                 na.rm = TRUE)) %>%
	  ungroup()
```

### Probablity of each mode (HBO)
	
Here we calculate the probability of taking a particular mode. 
	
```{r}
	skims <- skims %>%
	  mutate(p_transit_HBO = exp(utility_transit_HBO) / total_utility_HBO,
	         p_car_HBO = exp(utility_car_HBO) / total_utility_HBO,
	         p_active_HBO = exp(utility_active_HBO) / total_utility_HBO) 
```
	
Now we calculate the probability that someone who will travel by car will take an SOV or HOV and that someone who travels by active travel would bike or walk. 
	
```{r}
	skims <- skims %>%
	  mutate(p_SOV_if_car_HBO = exp(utility_SOV_HBO) / exp(utility_car_HBO),
	         p_HOV_if_car_HBO = exp(utility_HOV_HBO) / exp(utility_car_HBO),
	         p_walk_if_active_HBO = exp(utility_walk_HBO) / exp(utility_active_HBO),
	         p_bike_if_active_HBO = exp(utility_bike_HBO) / exp(utility_active_HBO))
```
	
Then we calculate the total probability for the modes within those nests and calculate the total number of trips by each mode. 
	
```{r}
	skims <- skims %>%
	  mutate(p_SOV_HBO = p_SOV_if_car_HBO * p_car_HBO,
	         p_HOV_HBO = p_HOV_if_car_HBO * p_car_HBO,
	         p_walk_HBO = p_walk_if_active_HBO * p_active_HBO,
	         p_bike_HBO = p_bike_if_active_HBO * p_active_HBO) 
```
	
### Number of trips by mode (HBO)
	
Last, we can multiply the mode shares by the trip flows we calculated in Assignment 8 to get the number of trips by each mode.
	
```{r}
	skims <- skims %>%
	  mutate(n_transit_HBO = round(HBO_flow * p_transit_HBO),
	         n_SOV_HBO = round(HBO_flow * p_SOV_HBO),
	         n_HOV_HBO = round(HBO_flow * p_HOV_HBO),
	         n_walk_HBO = round(HBO_flow * p_walk_HBO),
	         n_bike_HBO = round(HBO_flow * p_bike_HBO)) %>%
	  replace_na(list(n_transit_HBO = 0,
	                  n_SOV_HBO = 0,
	                  n_HOV_HBO = 0,
	                  n_walk_HBO = 0,
	                  n_bike_HBO =0)) 
```
	

### Calculate regional mode shares and compare to regional data
	
```{r}
	modeled_mode_by_purpose_1 <- tibble(
	  purpose = "HBO_model 1", 
	  pct_bike = sum(skims$n_bike_HBO) / 
	                 sum(skims$HBO_flow),
	  pct_SOV = sum(skims$n_SOV_HBO) / 
	                sum(skims$HBO_flow),
	  pct_HOV = sum(skims$n_HOV_HBO) / 
	                sum(skims$HBO_flow),
	  pct_transit = sum(skims$n_transit_HBO) / 
	                sum(skims$HBO_flow),
	  pct_walk = sum(skims$n_walk_HBO) / 
	                sum(skims$HBO_flow))
	
	model_compare <- rbind(mode_by_purpose, modeled_mode_by_purpose_1) 
	
	model_compare
```
	
Our model overestimates driving alone by 0.1 percentage points, HOV by 15.7 percentage points, underestimates transit by 2 percentage points, underestimates walking by 12 percentage points, and underestimates biking by 2 percentage points.
	
### Calibrate Model (HBO)
Model 1 Constants: 
	transit_const_HBO  <- -3.8
	SOV_const_HBO <- -0.7
	HOV_const_HBO <- -0.1
	bike_const_HBO <- -3.6
	walk_const_HBO <- -1.8
	
```{r}
	transit_const_HBO  <- -3.2
	SOV_const_HBO <- -0.7
	HOV_const_HBO <- -0.3
	bike_const_HBO <- -2.5
	walk_const_HBO <- -0.25
	
	skims <- skims %>%
	  mutate(utility_transit_HBO = transit_const_HBO +
	                               ride_time * -0.008  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.025 +
	                               transit_cost * -0.01,
	         utility_SOV_HBO = SOV_const_HBO +
	                           car_time * -0.008 +
	                           drive_cost * -0.01,
	         utility_HOV_HBO = HOV_const_HBO +
	                           car_time * -0.008 +
	                           carpool_cost * -0.01,
	         utility_walk_HBO = walk_const_HBO +
	                            walk_time * -0.025,
	         utility_bike_HBO = bike_const_HBO +
	                            bike_time * -0.025) %>%
	  mutate(exp_u_walk_HBO = exp(utility_walk_HBO),
	         exp_u_bike_HBO = exp(utility_bike_HBO),
	         exp_u_SOV_HBO = exp(utility_SOV_HBO),
	         exp_u_HOV_HBO = exp(utility_HOV_HBO),
	         exp_u_transit_HBO = exp(utility_transit_HBO)) %>%
	  rowwise() %>%
	  mutate(utility_active_HBO = log(sum(exp_u_walk_HBO, 
	                                          exp_u_bike_HBO, 
	                                          na.rm = TRUE)),
	         utility_car_HBO = log(sum(exp_u_SOV_HBO,
	                                       exp_u_HOV_HBO,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_HBO = exp(utility_active_HBO),
	         exp_u_car_HBO = exp(utility_car_HBO)) %>%
	  mutate(total_utility_HBO = sum(exp_u_active_HBO, 
	                                 exp_u_car_HBO,
	                                 exp_u_transit_HBO,
	                                 na.rm = TRUE)) %>%
	  ungroup()  %>%
	  mutate(p_transit_HBO = exp(utility_transit_HBO) / total_utility_HBO,
	         p_car_HBO = exp(utility_car_HBO) / total_utility_HBO,
	         p_active_HBO = exp(utility_active_HBO) / total_utility_HBO)  %>%
	  mutate(p_SOV_if_car_HBO = exp(utility_SOV_HBO) / exp(utility_car_HBO),
	         p_HOV_if_car_HBO = exp(utility_HOV_HBO) / exp(utility_car_HBO),
	         p_walk_if_active_HBO = exp(utility_walk_HBO) / exp(utility_active_HBO),
	         p_bike_if_active_HBO = exp(utility_bike_HBO) / exp(utility_active_HBO)) %>%
	  mutate(p_SOV_HBO = p_SOV_if_car_HBO * p_car_HBO,
	         p_HOV_HBO = p_HOV_if_car_HBO * p_car_HBO,
	         p_walk_HBO = p_walk_if_active_HBO * p_active_HBO,
	         p_bike_HBO = p_bike_if_active_HBO * p_active_HBO) %>%
	  mutate(n_transit_HBO = round(HBO_flow * p_transit_HBO),
	         n_SOV_HBO = round(HBO_flow * p_SOV_HBO),
	         n_HOV_HBO = round(HBO_flow * p_HOV_HBO),
	         n_walk_HBO = round(HBO_flow * p_walk_HBO),
	         n_bike_HBO = round(HBO_flow * p_bike_HBO)) %>%
	  replace_na(list(n_transit_HBO = 0,
	                  n_SOV_HBO = 0,
	                  n_HOV_HBO = 0,
	                  n_walk_HBO = 0,
	                  n_bike_HBO =0)) 
```
	
Let's compare again!
	
```{r}
	modeled_mode_by_purpose_2 <- tibble(
	  purpose = "HBO_model 2", 
	  pct_bike = sum(skims$n_bike_HBO) / 
	                 sum(skims$HBO_flow),
	  pct_SOV = sum(skims$n_SOV_HBO) / 
	                sum(skims$HBO_flow),
	  pct_HOV = sum(skims$n_HOV_HBO) / 
	                sum(skims$HBO_flow),
	  pct_transit = sum(skims$n_transit_HBO) / 
	                sum(skims$HBO_flow),
	  pct_walk = sum(skims$n_walk_HBO) / 
	                sum(skims$HBO_flow))
	
	model_compare2 <- rbind(model_compare, modeled_mode_by_purpose_2) 
	
	model_compare2
```
	
We are satisfied with HBO_Model 2
	
We have to repeat everything from line 214 to 452 for Existing conditions HBW, NHB and Alternative conditions HBO, HBW, and NHB.
	
#HBW Section
	
## Selecting a model

For HBW trips, we will use Model H. The coefficients are below. 
	In-vehicle time: -0.033
	Walk time: -0.093
	First wait time: -0.038
	Transfer wait time: -0.038
	Cost: -0.0021
	
### Calculate mode-specific constants (HBW)
	
```{r}
	SOV_share_HBW <- mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBW"]
	HOV_share_HBW <- mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBW"]
	transit_share_HBW <- mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBW"]
	walk_share_HBW <- mode_by_purpose$pct_walk[mode_by_purpose$purpose == "HBW"]
	bike_share_HBW <- mode_by_purpose$pct_bike[mode_by_purpose$purpose == "HBW"]
	
	SOV_const_HBW <- log(SOV_share_HBW / (1 - SOV_share_HBW))
	HOV_const_HBW <- log(HOV_share_HBW / (1 - HOV_share_HBW))
	transit_const_HBW <- log(transit_share_HBW / (1 - transit_share_HBW))
	walk_const_HBW <- log(walk_share_HBW / (1 - walk_share_HBW))
	bike_const_HBW <- log(bike_share_HBW / (1 - bike_share_HBW))
```
	
### Estimate utility of each mode (HBW)
	
Here is where we apply the coefficients from our model above. 
	
```{r}
	skims <- skims %>%
	  mutate(utility_transit_HBW = transit_const_HBW +
	                               ride_time * -0.033  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.038 +
	                               transit_cost * -0.0021,
	         utility_SOV_HBW = SOV_const_HBW +
	                           car_time * -0.033 +
	                           drive_cost * -0.0021,
	         utility_HOV_HBW = HOV_const_HBW +
	                           car_time * -0.033  +
	                           carpool_cost * -0.0021,
	         utility_walk_HBW = walk_const_HBW +
	                            walk_time * -0.093,
	         utility_bike_HBW = bike_const_HBW +
	                            bike_time * -0.093) %>%
	  mutate(exp_u_walk_HBW = exp(utility_walk_HBW),
	         exp_u_bike_HBW = exp(utility_bike_HBW),
	         exp_u_SOV_HBW = exp(utility_SOV_HBW),
	         exp_u_HOV_HBW = exp(utility_HOV_HBW),
	         exp_u_transit_HBW = exp(utility_transit_HBW)) %>%
	  rowwise() %>%
	  mutate(utility_active_HBW = log(sum(exp_u_walk_HBW, 
	                                          exp_u_bike_HBW, 
	                                          na.rm = TRUE)),
	         utility_car_HBW = log(sum(exp_u_SOV_HBW,
	                                       exp_u_HOV_HBW,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_HBW = exp(utility_active_HBW),
	         exp_u_car_HBW = exp(utility_car_HBW)) %>%
	  mutate(total_utility_HBW = sum(exp_u_active_HBW, 
	                                 exp_u_car_HBW,
	                                 exp_u_transit_HBW,
	                                 na.rm = TRUE)) %>%
	  ungroup()
```
	
### Probablity of each mode (HBW)
	
Here we calculate the probability of taking a particular mode. 
	
```{r}
	skims <- skims %>%
	  mutate(p_transit_HBW = exp(utility_transit_HBW) / total_utility_HBW,
	         p_car_HBW = exp(utility_car_HBW) / total_utility_HBW,
	         p_active_HBW = exp(utility_active_HBW) / total_utility_HBW) 
```
	
Now we calculate the probability that someone who will travel by car will take an SOV or HOV and that someone who travels by active travel would bike or walk. 
	
```{r}
	skims <- skims %>%
	  mutate(p_SOV_if_car_HBW = exp(utility_SOV_HBW) / exp(utility_car_HBW),
	         p_HOV_if_car_HBW = exp(utility_HOV_HBW) / exp(utility_car_HBW),
	         p_walk_if_active_HBW = exp(utility_walk_HBW) / exp(utility_active_HBW),
	         p_bike_if_active_HBW = exp(utility_bike_HBW) / exp(utility_active_HBW))
```
	
Then we calculate the total probability for the modes within those nests and calculate the total number of trips by each mode. 
	
```{r}
	skims <- skims %>%
	  mutate(p_SOV_HBW = p_SOV_if_car_HBW * p_car_HBW,
	         p_HOV_HBW = p_HOV_if_car_HBW * p_car_HBW,
	         p_walk_HBW = p_walk_if_active_HBW * p_active_HBW,
	         p_bike_HBW = p_bike_if_active_HBW * p_active_HBW) 
```
	
### Number of trips by mode (HBW)
	
Last, we can multiply the mode shares by the trip flows we calculated in Assignment 8 to get the number of trips by each mode.
	
```{r}
	skims <- skims %>%
	  mutate(n_transit_HBW = round(HBW_flow * p_transit_HBW),
	         n_SOV_HBW = round(HBW_flow * p_SOV_HBW),
	         n_HOV_HBW = round(HBW_flow * p_HOV_HBW),
	         n_walk_HBW = round(HBW_flow * p_walk_HBW),
	         n_bike_HBW = round(HBW_flow * p_bike_HBW)) %>%
	  replace_na(list(n_transit_HBW = 0,
	                  n_SOV_HBW = 0,
	                  n_HOV_HBW = 0,
	                  n_walk_HBW = 0,
	                  n_bike_HBW =0)) 
```
	

### Calculate regional mode shares and compare to regional data
	
```{r}
	modeled_mode_by_purpose_1 <- tibble(
	  purpose = "HBW_model 1", 
	  pct_bike = sum(skims$n_bike_HBW) / 
	                 sum(skims$HBW_flow),
	  pct_SOV = sum(skims$n_SOV_HBW) / 
	                sum(skims$HBW_flow),
	  pct_HOV = sum(skims$n_HOV_HBW) / 
	                sum(skims$HBW_flow),
	  pct_transit = sum(skims$n_transit_HBW) / 
	                sum(skims$HBW_flow),
	  pct_walk = sum(skims$n_walk_HBW) / 
	                sum(skims$HBW_flow))
	
	model_compare <- rbind(mode_by_purpose, modeled_mode_by_purpose_1) 
	
	model_compare
```
	
Our model overestimates driving alone by 0.1 percentage points, HOV by 15.7 percentage points, underestimates transit by 2 percentage points, underestimates walking by 12 percentage points, and underestimates biking by 2 percentage points.
	
### Calibrate Model (HBW)
Model 1 Constants: 
	transit_const_HBW  <- -3.2
	SOV_const_HBW <- -0.7
	HOV_const_HBW <- -0.1
	bike_const_HBW <- -3.6
	walk_const_HBW <- -1.8
	
```{r}
	transit_const_HBW  <- -0.1
	SOV_const_HBW <- -0.5
	HOV_const_HBW <- -2.5
	bike_const_HBW <- -1.1
	walk_const_HBW <- 5
	
skims <- skims %>%
	  mutate(utility_transit_HBW = transit_const_HBW +
	                               ride_time * -0.033  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.038 +
	                               transit_cost * -0.0021,
	         utility_SOV_HBW = SOV_const_HBW +
	                           car_time * -0.033 +
	                           drive_cost * -0.0021,
	         utility_HOV_HBW = HOV_const_HBW +
	                           car_time * -0.033  +
	                           carpool_cost * -0.0021,
	         utility_walk_HBW = walk_const_HBW +
	                            walk_time * -0.093,
	         utility_bike_HBW = bike_const_HBW +
	                            bike_time * -0.093) %>%
	  mutate(exp_u_walk_HBW = exp(utility_walk_HBW),
	         exp_u_bike_HBW = exp(utility_bike_HBW),
	         exp_u_SOV_HBW = exp(utility_SOV_HBW),
	         exp_u_HOV_HBW = exp(utility_HOV_HBW),
	         exp_u_transit_HBW = exp(utility_transit_HBW)) %>%
	  rowwise() %>%
	  mutate(utility_active_HBW = log(sum(exp_u_walk_HBW, 
	                                          exp_u_bike_HBW, 
	                                          na.rm = TRUE)),
	         utility_car_HBW = log(sum(exp_u_SOV_HBW,
	                                       exp_u_HOV_HBW,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_HBW = exp(utility_active_HBW),
	         exp_u_car_HBW = exp(utility_car_HBW)) %>%
	  mutate(total_utility_HBW = sum(exp_u_active_HBW, 
	                                 exp_u_car_HBW,
	                                 exp_u_transit_HBW,
	                                 na.rm = TRUE)) %>%
	  ungroup()  %>%
	  mutate(p_transit_HBW = exp(utility_transit_HBW) / total_utility_HBW,
	         p_car_HBW = exp(utility_car_HBW) / total_utility_HBW,
	         p_active_HBW = exp(utility_active_HBW) / total_utility_HBW)  %>%
	  mutate(p_SOV_if_car_HBW = exp(utility_SOV_HBW) / exp(utility_car_HBW),
	         p_HOV_if_car_HBW = exp(utility_HOV_HBW) / exp(utility_car_HBW),
	         p_walk_if_active_HBW = exp(utility_walk_HBW) / exp(utility_active_HBW),
	         p_bike_if_active_HBW = exp(utility_bike_HBW) / exp(utility_active_HBW)) %>%
	  mutate(p_SOV_HBW = p_SOV_if_car_HBW * p_car_HBW,
	         p_HOV_HBW = p_HOV_if_car_HBW * p_car_HBW,
	         p_walk_HBW = p_walk_if_active_HBW * p_active_HBW,
	         p_bike_HBW = p_bike_if_active_HBW * p_active_HBW) %>%
	  mutate(n_transit_HBW = round(HBW_flow * p_transit_HBW),
	         n_SOV_HBW = round(HBW_flow * p_SOV_HBW),
	         n_HOV_HBW = round(HBW_flow * p_HOV_HBW),
	         n_walk_HBW = round(HBW_flow * p_walk_HBW),
	         n_bike_HBW = round(HBW_flow * p_bike_HBW)) %>%
	  replace_na(list(n_transit_HBW = 0,
	                  n_SOV_HBW = 0,
	                  n_HOV_HBW = 0,
	                  n_walk_HBW = 0,
	                  n_bike_HBW =0)) 
```
	
Let's compare again!
	
```{r}
	modeled_mode_by_purpose_2 <- tibble(
	  purpose = "HBW_model 2", 
	  pct_bike = sum(skims$n_bike_HBW) / 
	                 sum(skims$HBW_flow),
	  pct_SOV = sum(skims$n_SOV_HBW) / 
	                sum(skims$HBW_flow),
	  pct_HOV = sum(skims$n_HOV_HBW) / 
	                sum(skims$HBW_flow),
	  pct_transit = sum(skims$n_transit_HBW) / 
	                sum(skims$HBW_flow),
	  pct_walk = sum(skims$n_walk_HBW) / 
	                sum(skims$HBW_flow))
	
	model_compare2 <- rbind(model_compare, modeled_mode_by_purpose_2) 
	
	model_compare2
```
#NHB Section
	
## Selecting a model
For NHB trips, we will use Model M. The coefficients are below: 
	In-vehicle time: -0.013
	Walk time: -0.032
	First wait time: -0.032
	Transfer wait time: -0.050
	Cost: -0.002

### Calculate mode-specific constants (NHB)
```{r}
	SOV_share_NHB <- mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "NHB"]
	HOV_share_NHB <- mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "NHB"]
	transit_share_NHB <- mode_by_purpose$pct_transit[mode_by_purpose$purpose == "NHB"]
	walk_share_NHB <- mode_by_purpose$pct_walk[mode_by_purpose$purpose == "NHB"]
	bike_share_NHB <- mode_by_purpose$pct_bike[mode_by_purpose$purpose == "NHB"]
	
	SOV_const_NHB <- log(SOV_share_NHB / (1 - SOV_share_NHB))
	HOV_const_NHB <- log(HOV_share_NHB / (1 - HOV_share_NHB))
	transit_const_NHB <- log(transit_share_NHB / (1 - transit_share_NHB))
	walk_const_NHB <- log(walk_share_NHB / (1 - walk_share_NHB))
	bike_const_NHB <- log(bike_share_NHB / (1 - bike_share_NHB))
```
	
### Estimate utility of each mode (NHB)
Here is where we apply the coefficients from our model above. 
```{r}
	skims <- skims %>%
	  mutate(utility_transit_NHB = transit_const_NHB +
	                               ride_time * -0.013  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.050 +
	                               transit_cost * -0.002,
	         utility_SOV_NHB = SOV_const_NHB +
	                           car_time * -0.013 +
	                           drive_cost * -0.002,
	         utility_HOV_NHB = HOV_const_NHB +
	                           car_time * -0.013  +
	                           carpool_cost * -0.002,
	         utility_walk_NHB = walk_const_NHB +
	                            walk_time * -0.032,
	         utility_bike_NHB = bike_const_NHB +
	                            bike_time * -0.032) %>%
	  mutate(exp_u_walk_NHB = exp(utility_walk_NHB),
	         exp_u_bike_NHB = exp(utility_bike_NHB),
	         exp_u_SOV_NHB = exp(utility_SOV_NHB),
	         exp_u_HOV_NHB = exp(utility_HOV_NHB),
	         exp_u_transit_NHB = exp(utility_transit_NHB)) %>%
	  rowwise() %>%
	  mutate(utility_active_NHB = log(sum(exp_u_walk_NHB, 
	                                          exp_u_bike_NHB, 
	                                          na.rm = TRUE)),
	         utility_car_NHB = log(sum(exp_u_SOV_NHB,
	                                       exp_u_HOV_NHB,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_NHB = exp(utility_active_NHB),
	         exp_u_car_NHB = exp(utility_car_NHB)) %>%
	  mutate(total_utility_NHB = sum(exp_u_active_NHB, 
	                                 exp_u_car_NHB,
	                                 exp_u_transit_NHB,
	                                 na.rm = TRUE)) %>%
	  ungroup()
```
	
### Probablity of each mode (NHB)
	
Here we calculate the probability of taking a particular mode. 
	
```{r}
	skims <- skims %>%
	  mutate(p_transit_NHB = exp(utility_transit_NHB) / total_utility_NHB,
	         p_car_NHB = exp(utility_car_NHB) / total_utility_NHB,
	         p_active_NHB = exp(utility_active_NHB) / total_utility_NHB) 
```
	
Now we calculate the probability that someone who will travel by car will take an SOV or HOV and that someone who travels by active travel would bike or walk. 
	
```{r}
	skims <- skims %>%
	  mutate(p_SOV_if_car_NHB = exp(utility_SOV_NHB) / exp(utility_car_NHB),
	         p_HOV_if_car_NHB = exp(utility_HOV_NHB) / exp(utility_car_NHB),
	         p_walk_if_active_NHB = exp(utility_walk_NHB) / exp(utility_active_NHB),
	         p_bike_if_active_NHB = exp(utility_bike_NHB) / exp(utility_active_NHB))
```
	
Then we calculate the total probability for the modes within those nests and calculate the total number of trips by each mode. 
	
```{r}
	skims <- skims %>%
	  mutate(p_SOV_NHB = p_SOV_if_car_NHB * p_car_NHB,
	         p_HOV_NHB = p_HOV_if_car_NHB * p_car_NHB,
	         p_walk_NHB = p_walk_if_active_NHB * p_active_NHB,
	         p_bike_NHB = p_bike_if_active_NHB * p_active_NHB) 
```
	
### Number of trips by mode (NHB)
	Last, we can multiply the mode shares by the trip flows we calculated in Assignment 8 to get the number of trips by each mode.
```{r}
	skims <- skims %>%
	  mutate(n_transit_NHB = round(NHB_flow * p_transit_NHB),
	         n_SOV_NHB = round(NHB_flow * p_SOV_NHB),
	         n_HOV_NHB = round(NHB_flow * p_HOV_NHB),
	         n_walk_NHB = round(NHB_flow * p_walk_NHB),
	         n_bike_NHB = round(NHB_flow * p_bike_NHB)) %>%
	  replace_na(list(n_transit_NHB = 0,
	                  n_SOV_NHB = 0,
	                  n_HOV_NHB = 0,
	                  n_walk_NHB = 0,
	                  n_bike_NHB =0)) 
```
	
### Calculate regional mode shares and compare to regional data
```{r}
	modeled_mode_by_purpose_1 <- tibble(
	  purpose = "NHB_model 1", 
	  pct_bike = sum(skims$n_bike_NHB) / 
	                 sum(skims$NHB_flow),
	  pct_SOV = sum(skims$n_SOV_NHB) / 
	                sum(skims$NHB_flow),
	  pct_HOV = sum(skims$n_HOV_NHB) / 
	                sum(skims$NHB_flow),
	  pct_transit = sum(skims$n_transit_NHB) / 
	                sum(skims$NHB_flow),
	  pct_walk = sum(skims$n_walk_NHB) / 
	                sum(skims$NHB_flow))
	
	model_compare <- rbind(mode_by_purpose, modeled_mode_by_purpose_1) 
	
	model_compare
```
	
Our model overestimates driving alone by 0.1 percentage points, HOV by 15.7 percentage points, underestimates transit by 2 percentage points, underestimates walking by 12 percentage points, and underestimates biking by 2 percentage points.
	
### Calibrate Model (NHB)
Model 1 Constants: 
	transit_const_NHB  <- -0.1
	SOV_const_NHB <- -0.5
	HOV_const_NHB <- -2.5
	bike_const_NHB <- -1.1
	walk_const_NHB <- 5
	
```{r}
	transit_const_NHB  <- -0.05
	SOV_const_NHB <- -0.7
	HOV_const_NHB <- -0.3
	bike_const_NHB <- -1.1
	walk_const_NHB <- 2.5
	
	skims <- skims %>%
	  mutate(utility_transit_NHB = transit_const_NHB +
	                               ride_time * -0.033  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.038 +
	                               transit_cost * -0.0021,
	         utility_SOV_NHB = SOV_const_NHB +
	                           car_time * -0.033 +
	                           drive_cost * -0.0021,
	         utility_HOV_NHB = HOV_const_NHB +
	                           car_time * -0.033  +
	                           carpool_cost * -0.0021,
	         utility_walk_NHB = walk_const_NHB +
	                            walk_time * -0.093,
	         utility_bike_NHB = bike_const_NHB +
	                            bike_time * -0.093) %>%
	  mutate(exp_u_walk_NHB = exp(utility_walk_NHB),
	         exp_u_bike_NHB = exp(utility_bike_NHB),
	         exp_u_SOV_NHB = exp(utility_SOV_NHB),
	         exp_u_HOV_NHB = exp(utility_HOV_NHB),
	         exp_u_transit_NHB = exp(utility_transit_NHB)) %>%
	  rowwise() %>%
	  mutate(utility_active_NHB = log(sum(exp_u_walk_NHB, 
	                                          exp_u_bike_NHB, 
	                                          na.rm = TRUE)),
	         utility_car_NHB = log(sum(exp_u_SOV_NHB,
	                                       exp_u_HOV_NHB,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_NHB = exp(utility_active_NHB),
	         exp_u_car_NHB = exp(utility_car_NHB)) %>%
	  mutate(total_utility_NHB = sum(exp_u_active_NHB, 
	                                 exp_u_car_NHB,
	                                 exp_u_transit_NHB,
	                                 na.rm = TRUE)) %>%
	  ungroup()  %>%
	  mutate(p_transit_NHB = exp(utility_transit_NHB) / total_utility_NHB,
	         p_car_NHB = exp(utility_car_NHB) / total_utility_NHB,
	         p_active_NHB = exp(utility_active_NHB) / total_utility_NHB)  %>%
	  mutate(p_SOV_if_car_NHB = exp(utility_SOV_NHB) / exp(utility_car_NHB),
	         p_HOV_if_car_NHB = exp(utility_HOV_NHB) / exp(utility_car_NHB),
	         p_walk_if_active_NHB = exp(utility_walk_NHB) / exp(utility_active_NHB),
	         p_bike_if_active_NHB = exp(utility_bike_NHB) / exp(utility_active_NHB)) %>%
	  mutate(p_SOV_NHB = p_SOV_if_car_NHB * p_car_NHB,
	         p_HOV_NHB = p_HOV_if_car_NHB * p_car_NHB,
	         p_walk_NHB = p_walk_if_active_NHB * p_active_NHB,
	         p_bike_NHB = p_bike_if_active_NHB * p_active_NHB) %>%
	  mutate(n_transit_NHB = round(NHB_flow * p_transit_NHB),
	         n_SOV_NHB = round(NHB_flow * p_SOV_NHB),
	         n_HOV_NHB = round(NHB_flow * p_HOV_NHB),
	         n_walk_NHB = round(NHB_flow * p_walk_NHB),
	         n_bike_NHB = round(NHB_flow * p_bike_NHB)) %>%
	  replace_na(list(n_transit_NHB = 0,
	                  n_SOV_NHB = 0,
	                  n_HOV_NHB = 0,
	                  n_walk_NHB = 0,
	                  n_bike_NHB =0)) 
```
	
Let's compare again!
	
```{r}
	modeled_mode_by_purpose_2 <- tibble(
	  purpose = "NHB_model 2", 
	  pct_bike = sum(skims$n_bike_NHB) / 
	                 sum(skims$NHB_flow),
	  pct_SOV = sum(skims$n_SOV_NHB) / 
	                sum(skims$NHB_flow),
	  pct_HOV = sum(skims$n_HOV_NHB) / 
	                sum(skims$NHB_flow),
	  pct_transit = sum(skims$n_transit_NHB) / 
	                sum(skims$NHB_flow),
	  pct_walk = sum(skims$n_walk_NHB) / 
	                sum(skims$NHB_flow))
	
	model_compare2 <- rbind(model_compare, modeled_mode_by_purpose_2) 
	
	model_compare2
```
### ALTERNATIVE SECTION ###
## HBO ALT
	
### Calculate mode-specific constants (HBO)
	
```{r}
	SOV_share_HBO <- mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBO"]
	HOV_share_HBO <- mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBO"]
	transit_share_HBO <- mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBO"]
	walk_share_HBO <- mode_by_purpose$pct_walk[mode_by_purpose$purpose == "HBO"]
	bike_share_HBO <- mode_by_purpose$pct_bike[mode_by_purpose$purpose == "HBO"]
	
	SOV_const_HBO <- log(SOV_share_HBO / (1 - SOV_share_HBO))
	HOV_const_HBO <- log(HOV_share_HBO / (1 - HOV_share_HBO))
	transit_const_HBO <- log(transit_share_HBO / (1 - transit_share_HBO))
	walk_const_HBO <- log(walk_share_HBO / (1 - walk_share_HBO))
	bike_const_HBO <- log(bike_share_HBO / (1 - bike_share_HBO))
```
### Estimate utility of each mode (HBO)
Here is where we apply the coefficients from our model above. 
```{r}
	alt_skims <- alt_skims %>%
	  mutate(utility_transit_HBO = transit_const_HBO +
	                               ride_time * -0.008  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.025 +
	                               transit_cost * -0.01,
	         utility_SOV_HBO = SOV_const_HBO +
	                           car_time * -0.008 +
	                           drive_cost * -0.01,
	         utility_HOV_HBO = HOV_const_HBO +
	                           car_time * -0.008 +
	                           carpool_cost * -0.01,
	         utility_walk_HBO = walk_const_HBO +
	                            walk_time * -0.025,
	         utility_bike_HBO = bike_const_HBO +
	                            bike_time * -0.025) %>%
	  mutate(exp_u_walk_HBO = exp(utility_walk_HBO),
	         exp_u_bike_HBO = exp(utility_bike_HBO),
	         exp_u_SOV_HBO = exp(utility_SOV_HBO),
	         exp_u_HOV_HBO = exp(utility_HOV_HBO),
	         exp_u_transit_HBO = exp(utility_transit_HBO)) %>%
	  rowwise() %>%
	  mutate(utility_active_HBO = log(sum(exp_u_walk_HBO, 
	                                          exp_u_bike_HBO, 
	                                          na.rm = TRUE)),
	         utility_car_HBO = log(sum(exp_u_SOV_HBO,
	                                       exp_u_HOV_HBO,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_HBO = exp(utility_active_HBO),
	         exp_u_car_HBO = exp(utility_car_HBO)) %>%
	  mutate(total_utility_HBO = sum(exp_u_active_HBO, 
	                                 exp_u_car_HBO,
	                                 exp_u_transit_HBO,
	                                 na.rm = TRUE)) %>%
	  ungroup()
```
	
### Probablity of each mode (HBO)
	Here we calculate the probability of taking a particular mode. 
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(p_transit_HBO = exp(utility_transit_HBO) / total_utility_HBO,
	         p_car_HBO = exp(utility_car_HBO) / total_utility_HBO,
	         p_active_HBO = exp(utility_active_HBO) / total_utility_HBO) 
```
	
Now we calculate the probability that someone who will travel by car will take an SOV or HOV and that someone who travels by active travel would bike or walk. 
	

```{r}
	alt_skims <- alt_skims %>%
	  mutate(p_SOV_if_car_HBO = exp(utility_SOV_HBO) / exp(utility_car_HBO),
	         p_HOV_if_car_HBO = exp(utility_HOV_HBO) / exp(utility_car_HBO),
	         p_walk_if_active_HBO = exp(utility_walk_HBO) / exp(utility_active_HBO),
	         p_bike_if_active_HBO = exp(utility_bike_HBO) / exp(utility_active_HBO))
```
	

Then we calculate the total probability for the modes within those nests and calculate the total number of trips by each mode. 
	

```{r}
	alt_skims <- alt_skims %>%
	  mutate(p_SOV_HBO = p_SOV_if_car_HBO * p_car_HBO,
	         p_HOV_HBO = p_HOV_if_car_HBO * p_car_HBO,
	         p_walk_HBO = p_walk_if_active_HBO * p_active_HBO,
	         p_bike_HBO = p_bike_if_active_HBO * p_active_HBO) 
```
	
### Number of trips by mode (HBO)
Last, we can multiply the mode shares by the trip flows we calculated in Assignment 8 to get the number of trips by each mode.
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(n_transit_HBO = round(HBO_flow * p_transit_HBO),
	         n_SOV_HBO = round(HBO_flow * p_SOV_HBO),
	         n_HOV_HBO = round(HBO_flow * p_HOV_HBO),
	         n_walk_HBO = round(HBO_flow * p_walk_HBO),
	         n_bike_HBO = round(HBO_flow * p_bike_HBO)) %>%
	  replace_na(list(n_transit_HBO = 0,
	                  n_SOV_HBO = 0,
	                  n_HOV_HBO = 0,
	                  n_walk_HBO = 0,
	                  n_bike_HBO =0)) 
```
	
### Calculate regional mode shares and compare to regional data
	
```{r}
	alt_modeled_mode_by_purpose_1 <- tibble(
	  purpose = "HBO_model_alt 1", 
	  pct_bike = sum(alt_skims$n_bike_HBO) / 
	                 sum(alt_skims$HBO_flow),
	  pct_SOV = sum(alt_skims$n_SOV_HBO) / 
	                sum(alt_skims$HBO_flow),
	  pct_HOV = sum(alt_skims$n_HOV_HBO) / 
	                sum(alt_skims$HBO_flow),
	  pct_transit = sum(alt_skims$n_transit_HBO) / 
	                sum(alt_skims$HBO_flow),
	  pct_walk = sum(alt_skims$n_walk_HBO) / 
	                sum(alt_skims$HBO_flow))
	
	model_compare <- rbind(mode_by_purpose, alt_modeled_mode_by_purpose_1) 
	
	model_compare
```
	
Our model overestimates driving alone by 0.1 percentage points, HOV by 15.7 percentage points, underestimates transit by 2 percentage points, underestimates walking by 12 percentage points, and underestimates biking by 2 percentage points.
	
### Calibrate Model (HBO)
	Model 1 Constants: 
	transit_const_HBO  <- -3.8
	SOV_const_HBO <- -0.7
	HOV_const_HBO <- -0.1
	bike_const_HBO <- -3.6
	walk_const_HBO <- -1.8
```{r}
	transit_const_HBO  <- -1.6
	SOV_const_HBO <- -0.7
	HOV_const_HBO <- -0.3
	bike_const_HBO <- -2.2
	walk_const_HBO <- 0.5
	
	alt_skims <- alt_skims %>%
	  mutate(utility_transit_HBO = transit_const_HBO +
	                               ride_time * -0.008  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.025 +
	                               transit_cost * -0.01,
	         utility_SOV_HBO = SOV_const_HBO +
	                           car_time * -0.008 +
	                           drive_cost * -0.01,
	         utility_HOV_HBO = HOV_const_HBO +
	                           car_time * -0.008 +
	                           carpool_cost * -0.01,
	         utility_walk_HBO = walk_const_HBO +
	                            walk_time * -0.025,
	         utility_bike_HBO = bike_const_HBO +
	                            bike_time * -0.025) %>%
	  mutate(exp_u_walk_HBO = exp(utility_walk_HBO),
	         exp_u_bike_HBO = exp(utility_bike_HBO),
	         exp_u_SOV_HBO = exp(utility_SOV_HBO),
	         exp_u_HOV_HBO = exp(utility_HOV_HBO),
	         exp_u_transit_HBO = exp(utility_transit_HBO)) %>%
	  rowwise() %>%
	  mutate(utility_active_HBO = log(sum(exp_u_walk_HBO, 
	                                          exp_u_bike_HBO, 
	                                          na.rm = TRUE)),
	         utility_car_HBO = log(sum(exp_u_SOV_HBO,
	                                       exp_u_HOV_HBO,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_HBO = exp(utility_active_HBO),
	         exp_u_car_HBO = exp(utility_car_HBO)) %>%
	  mutate(total_utility_HBO = sum(exp_u_active_HBO, 
	                                 exp_u_car_HBO,
	                                 exp_u_transit_HBO,
	                                 na.rm = TRUE)) %>%
	  ungroup()  %>%
	  mutate(p_transit_HBO = exp(utility_transit_HBO) / total_utility_HBO,
	         p_car_HBO = exp(utility_car_HBO) / total_utility_HBO,
	         p_active_HBO = exp(utility_active_HBO) / total_utility_HBO)  %>%
	  mutate(p_SOV_if_car_HBO = exp(utility_SOV_HBO) / exp(utility_car_HBO),
	         p_HOV_if_car_HBO = exp(utility_HOV_HBO) / exp(utility_car_HBO),
	         p_walk_if_active_HBO = exp(utility_walk_HBO) / exp(utility_active_HBO),
	         p_bike_if_active_HBO = exp(utility_bike_HBO) / exp(utility_active_HBO)) %>%
	  mutate(p_SOV_HBO = p_SOV_if_car_HBO * p_car_HBO,
	         p_HOV_HBO = p_HOV_if_car_HBO * p_car_HBO,
	         p_walk_HBO = p_walk_if_active_HBO * p_active_HBO,
	         p_bike_HBO = p_bike_if_active_HBO * p_active_HBO) %>%
	  mutate(n_transit_HBO = round(HBO_flow * p_transit_HBO),
	         n_SOV_HBO = round(HBO_flow * p_SOV_HBO),
	         n_HOV_HBO = round(HBO_flow * p_HOV_HBO),
	         n_walk_HBO = round(HBO_flow * p_walk_HBO),
	         n_bike_HBO = round(HBO_flow * p_bike_HBO)) %>%
	  replace_na(list(n_transit_HBO = 0,
	                  n_SOV_HBO = 0,
	                  n_HOV_HBO = 0,
	                  n_walk_HBO = 0,
	                  n_bike_HBO =0)) 
```
	
Let's compare again!
```{r}
	alt_modeled_mode_by_purpose_2 <- tibble(
	  purpose = "HBO_model_alt 2", 
	  pct_bike = sum(alt_skims$n_bike_HBO) / 
	                 sum(alt_skims$HBO_flow),
	  pct_SOV = sum(alt_skims$n_SOV_HBO) / 
	                sum(alt_skims$HBO_flow),
	  pct_HOV = sum(alt_skims$n_HOV_HBO) / 
	                sum(alt_skims$HBO_flow),
	  pct_transit = sum(alt_skims$n_transit_HBO) / 
	                sum(alt_skims$HBO_flow),
	  pct_walk = sum(alt_skims$n_walk_HBO) / 
	                sum(alt_skims$HBO_flow))
	
	model_compare2 <- rbind(model_compare, alt_modeled_mode_by_purpose_2) 
	
	model_compare2
```

#HBW ALT
## Selecting a model
For HBW trips, we will use Model H. The coefficients are below. 
	In-vehicle time: -0.033
	Walk time: -0.093
	First wait time: -0.038
	Transfer wait time: -0.038
	Cost: -0.0021
### Calculate mode-specific constants (HBW)
```{r}
	SOV_share_HBW <- mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBW"]
	HOV_share_HBW <- mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBW"]
	transit_share_HBW <- mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBW"]
	walk_share_HBW <- mode_by_purpose$pct_walk[mode_by_purpose$purpose == "HBW"]
	bike_share_HBW <- mode_by_purpose$pct_bike[mode_by_purpose$purpose == "HBW"]
	
	SOV_const_HBW <- log(SOV_share_HBW / (1 - SOV_share_HBW))
	HOV_const_HBW <- log(HOV_share_HBW / (1 - HOV_share_HBW))
	transit_const_HBW <- log(transit_share_HBW / (1 - transit_share_HBW))
	walk_const_HBW <- log(walk_share_HBW / (1 - walk_share_HBW))
	bike_const_HBW <- log(bike_share_HBW / (1 - bike_share_HBW))
```
### Estimate utility of each mode (HBW)
Here is where we apply the coefficients from our model above. 
```{r}
	alt_skims <- alt_skims %>%
	  mutate(utility_transit_HBW = transit_const_HBW +
	                               ride_time * -0.033  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.038 +
	                               transit_cost * -0.0021,
	         utility_SOV_HBW = SOV_const_HBW +
	                           car_time * -0.033 +
	                           drive_cost * -0.0021,
	         utility_HOV_HBW = HOV_const_HBW +
	                           car_time * -0.033 +
	                           carpool_cost * -0.0021,
	         utility_walk_HBW = walk_const_HBW +
	                            walk_time * -0.093,
	         utility_bike_HBW = bike_const_HBW +
	                            bike_time * -0.093) %>%
	  mutate(exp_u_walk_HBW = exp(utility_walk_HBW),
	         exp_u_bike_HBW = exp(utility_bike_HBW),
	         exp_u_SOV_HBW = exp(utility_SOV_HBW),
	         exp_u_HOV_HBW = exp(utility_HOV_HBW),
	         exp_u_transit_HBW = exp(utility_transit_HBW)) %>%
	  rowwise() %>%
	  mutate(utility_active_HBW = log(sum(exp_u_walk_HBW, 
	                                          exp_u_bike_HBW, 
	                                          na.rm = TRUE)),
	         utility_car_HBW = log(sum(exp_u_SOV_HBW,
	                                       exp_u_HOV_HBW,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_HBW = exp(utility_active_HBW),
	         exp_u_car_HBW = exp(utility_car_HBW)) %>%
	  mutate(total_utility_HBW = sum(exp_u_active_HBW, 
	                                 exp_u_car_HBW,
	                                 exp_u_transit_HBW,
	                                 na.rm = TRUE)) %>%
	  ungroup()
```
### Probablity of each mode (HBW)
Here we calculate the probability of taking a particular mode. 
```{r}
	alt_skims <- alt_skims %>%
	  mutate(p_transit_HBW = exp(utility_transit_HBW) / total_utility_HBW,
	         p_car_HBW = exp(utility_car_HBW) / total_utility_HBW,
	         p_active_HBW = exp(utility_active_HBW) / total_utility_HBW) 
```
Now we calculate the probability that someone who will travel by car will take an SOV or HOV and that someone who travels by active travel would bike or walk. 
```{r}
	alt_skims <- alt_skims %>%
	  mutate(p_SOV_if_car_HBW = exp(utility_SOV_HBW) / exp(utility_car_HBW),
	         p_HOV_if_car_HBW = exp(utility_HOV_HBW) / exp(utility_car_HBW),
	         p_walk_if_active_HBW = exp(utility_walk_HBW) / exp(utility_active_HBW),
	         p_bike_if_active_HBW = exp(utility_bike_HBW) / exp(utility_active_HBW))
```
	
Then we calculate the total probability for the modes within those nests and calculate the total number of trips by each mode. 
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(p_SOV_HBW = p_SOV_if_car_HBW * p_car_HBW,
	         p_HOV_HBW = p_HOV_if_car_HBW * p_car_HBW,
	         p_walk_HBW = p_walk_if_active_HBW * p_active_HBW,
	         p_bike_HBW = p_bike_if_active_HBW * p_active_HBW) 
```
### Number of trips by mode (HBW)
Last, we can multiply the mode shares by the trip flows we calculated in Assignment 8 to get the number of trips by each mode.
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(n_transit_HBW = round(HBW_flow * p_transit_HBW),
	         n_SOV_HBW = round(HBW_flow * p_SOV_HBW),
	         n_HOV_HBW = round(HBW_flow * p_HOV_HBW),
	         n_walk_HBW = round(HBW_flow * p_walk_HBW),
	         n_bike_HBW = round(HBW_flow * p_bike_HBW)) %>%
	  replace_na(list(n_transit_HBW = 0,
	                  n_SOV_HBW = 0,
	                  n_HOV_HBW = 0,
	                  n_walk_HBW = 0,
	                  n_bike_HBW =0)) 
```
### Calculate regional mode shares and compare to regional data
	
```{r}
	alt_modeled_mode_by_purpose_1 <- tibble(
	  purpose = "HBW_model_alt 1", 
	  pct_bike = sum(alt_skims$n_bike_HBW) / 
	                 sum(alt_skims$HBW_flow),
	  pct_SOV = sum(alt_skims$n_SOV_HBW) / 
	                sum(alt_skims$HBW_flow),
	  pct_HOV = sum(alt_skims$n_HOV_HBW) / 
	                sum(alt_skims$HBW_flow),
	  pct_transit = sum(alt_skims$n_transit_HBW) / 
	                sum(alt_skims$HBW_flow),
	  pct_walk = sum(alt_skims$n_walk_HBW) / 
	                sum(alt_skims$HBW_flow))
	
	model_compare <- rbind(mode_by_purpose, alt_modeled_mode_by_purpose_1) 
	
	model_compare
```
	Our model overestimates driving alone by 0.1 percentage points, HOV by 15.7 percentage points, underestimates transit by 2 percentage points, underestimates walking by 12 percentage points, and underestimates biking by 2 percentage points.
	
### Calibrate Model (HBW)
	

	Model 1 Constants: 
	transit_const_HBW  <- -3.2
	SOV_const_HBW <- -0.7
	HOV_const_HBW <- -0.1
	bike_const_HBW <- -3.6
	walk_const_HBW <- -1.8
	

```{r}
	transit_const_HBW  <- 0
	SOV_const_HBW <- 0
	HOV_const_HBW <- -2
	bike_const_HBW <- -2.3
	walk_const_HBW <- 6
	
	alt_skims <- alt_skims %>%
	  mutate(utility_transit_HBW = transit_const_HBW +
	                               ride_time * -0.033  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.038 +
	                               transit_cost * -0.0021,
	         utility_SOV_HBW = SOV_const_HBW +
	                           car_time * -0.033 +
	                           drive_cost * -0.0021,
	         utility_HOV_HBW = HOV_const_HBW +
	                           car_time * -0.033 +
	                           carpool_cost * -0.0021,
	         utility_walk_HBW = walk_const_HBW +
	                            walk_time * -0.093,
	         utility_bike_HBW = bike_const_HBW +
	                            bike_time * -0.093) %>%
	  mutate(exp_u_walk_HBW = exp(utility_walk_HBW),
	         exp_u_bike_HBW = exp(utility_bike_HBW),
	         exp_u_SOV_HBW = exp(utility_SOV_HBW),
	         exp_u_HOV_HBW = exp(utility_HOV_HBW),
	         exp_u_transit_HBW = exp(utility_transit_HBW)) %>%
	  rowwise() %>%
	  mutate(utility_active_HBW = log(sum(exp_u_walk_HBW, 
	                                          exp_u_bike_HBW, 
	                                          na.rm = TRUE)),
	         utility_car_HBW = log(sum(exp_u_SOV_HBW,
	                                       exp_u_HOV_HBW,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_HBW = exp(utility_active_HBW),
	         exp_u_car_HBW = exp(utility_car_HBW)) %>%
	  mutate(total_utility_HBW = sum(exp_u_active_HBW, 
	                                 exp_u_car_HBW,
	                                 exp_u_transit_HBW,
	                                 na.rm = TRUE)) %>%
	  ungroup()  %>%
	  mutate(p_transit_HBW = exp(utility_transit_HBW) / total_utility_HBW,
	         p_car_HBW = exp(utility_car_HBW) / total_utility_HBW,
	         p_active_HBW = exp(utility_active_HBW) / total_utility_HBW)  %>%
	  mutate(p_SOV_if_car_HBW = exp(utility_SOV_HBW) / exp(utility_car_HBW),
	         p_HOV_if_car_HBW = exp(utility_HOV_HBW) / exp(utility_car_HBW),
	         p_walk_if_active_HBW = exp(utility_walk_HBW) / exp(utility_active_HBW),
	         p_bike_if_active_HBW = exp(utility_bike_HBW) / exp(utility_active_HBW)) %>%
	  mutate(p_SOV_HBW = p_SOV_if_car_HBW * p_car_HBW,
	         p_HOV_HBW = p_HOV_if_car_HBW * p_car_HBW,
	         p_walk_HBW = p_walk_if_active_HBW * p_active_HBW,
	         p_bike_HBW = p_bike_if_active_HBW * p_active_HBW) %>%
	  mutate(n_transit_HBW = round(HBW_flow * p_transit_HBW),
	         n_SOV_HBW = round(HBW_flow * p_SOV_HBW),
	         n_HOV_HBW = round(HBW_flow * p_HOV_HBW),
	         n_walk_HBW = round(HBW_flow * p_walk_HBW),
	         n_bike_HBW = round(HBW_flow * p_bike_HBW)) %>%
	  replace_na(list(n_transit_HBW = 0,
	                  n_SOV_HBW = 0,
	                  n_HOV_HBW = 0,
	                  n_walk_HBW = 0,
	                  n_bike_HBW =0)) 
```
Let's compare again!
	
```{r}
	alt_modeled_mode_by_purpose_2 <- tibble(
	  purpose = "HBW_model_alt 2", 
	  pct_bike = sum(alt_skims$n_bike_HBW) / 
	                 sum(alt_skims$HBW_flow),
	  pct_SOV = sum(alt_skims$n_SOV_HBW) / 
	                sum(alt_skims$HBW_flow),
	  pct_HOV = sum(alt_skims$n_HOV_HBW) / 
	                sum(alt_skims$HBW_flow),
	  pct_transit = sum(alt_skims$n_transit_HBW) / 
	                sum(alt_skims$HBW_flow),
	  pct_walk = sum(alt_skims$n_walk_HBW) / 
	                sum(alt_skims$HBW_flow))
	
	model_compare2 <- rbind(model_compare, alt_modeled_mode_by_purpose_2) 
	
	model_compare2
```
#NHB ALT
## Selecting a model
For NHB trips, we will use Model M. The coefficients are below: 
	In-vehicle time: -0.013
	Walk time: -0.032
	First wait time: -0.032
	Transfer wait time: -0.050
	Cost: -0.002
	### Calculate mode-specific constants (NHB)
```{r}
	SOV_share_NHB <- mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "NHB"]
	HOV_share_NHB <- mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "NHB"]
	transit_share_NHB <- mode_by_purpose$pct_transit[mode_by_purpose$purpose == "NHB"]
	walk_share_NHB <- mode_by_purpose$pct_walk[mode_by_purpose$purpose == "NHB"]
	bike_share_NHB <- mode_by_purpose$pct_bike[mode_by_purpose$purpose == "NHB"]
	
	SOV_const_NHB <- log(SOV_share_NHB / (1 - SOV_share_NHB))
	HOV_const_NHB <- log(HOV_share_NHB / (1 - HOV_share_NHB))
	transit_const_NHB <- log(transit_share_NHB / (1 - transit_share_NHB))
	walk_const_NHB <- log(walk_share_NHB / (1 - walk_share_NHB))
	bike_const_NHB <- log(bike_share_NHB / (1 - bike_share_NHB))
```
	
### Estimate utility of each mode (NHB)
	
Here is where we apply the coefficients from our model above. 
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(utility_transit_NHB = transit_const_NHB +
	                               ride_time * -0.013  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.050 +
	                               transit_cost * -0.002,
	         utility_SOV_NHB = SOV_const_NHB +
	                           car_time * -0.013 +
	                           drive_cost * -0.002,
	         utility_HOV_NHB = HOV_const_NHB +
	                           car_time * -0.013 +
	                           carpool_cost * -0.002,
	         utility_walk_NHB = walk_const_NHB +
	                            walk_time * -0.032,
	         utility_bike_NHB = bike_const_NHB +
	                            bike_time * -0.032) %>%
	  mutate(exp_u_walk_NHB = exp(utility_walk_NHB),
	         exp_u_bike_NHB = exp(utility_bike_NHB),
	         exp_u_SOV_NHB = exp(utility_SOV_NHB),
	         exp_u_HOV_NHB = exp(utility_HOV_NHB),
	         exp_u_transit_NHB = exp(utility_transit_NHB)) %>%
	  rowwise() %>%
	  mutate(utility_active_NHB = log(sum(exp_u_walk_NHB, 
	                                          exp_u_bike_NHB, 
	                                          na.rm = TRUE)),
	         utility_car_NHB = log(sum(exp_u_SOV_NHB,
	                                       exp_u_HOV_NHB,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_NHB = exp(utility_active_NHB),
	         exp_u_car_NHB = exp(utility_car_NHB)) %>%
	  mutate(total_utility_NHB = sum(exp_u_active_NHB, 
	                                 exp_u_car_NHB,
	                                 exp_u_transit_NHB,
	                                 na.rm = TRUE)) %>%
	  ungroup()
```
	
### Probablity of each mode (NHB)
	
Here we calculate the probability of taking a particular mode. 
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(p_transit_NHB = exp(utility_transit_NHB) / total_utility_NHB,
	         p_car_NHB = exp(utility_car_NHB) / total_utility_NHB,
	         p_active_NHB = exp(utility_active_NHB) / total_utility_NHB) 
```
	
Now we calculate the probability that someone who will travel by car will take an SOV or HOV and that someone who travels by active travel would bike or walk. 
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(p_SOV_if_car_NHB = exp(utility_SOV_NHB) / exp(utility_car_NHB),
	         p_HOV_if_car_NHB = exp(utility_HOV_NHB) / exp(utility_car_NHB),
	         p_walk_if_active_NHB = exp(utility_walk_NHB) / exp(utility_active_NHB),
	         p_bike_if_active_NHB = exp(utility_bike_NHB) / exp(utility_active_NHB))
```
	

	Then we calculate the total probability for the modes within those nests and calculate the total number of trips by each mode. 
	

```{r}
	alt_skims <- alt_skims %>%
	  mutate(p_SOV_NHB = p_SOV_if_car_NHB * p_car_NHB,
	         p_HOV_NHB = p_HOV_if_car_NHB * p_car_NHB,
	         p_walk_NHB = p_walk_if_active_NHB * p_active_NHB,
	         p_bike_NHB = p_bike_if_active_NHB * p_active_NHB) 
```
	

	### Number of trips by mode (NHB)
	

	Last, we can multiply the mode shares by the trip flows we calculated in Assignment 8 to get the number of trips by each mode.
	
```{r}
	alt_skims <- alt_skims %>%
	  mutate(n_transit_NHB = round(NHB_flow * p_transit_NHB),
	         n_SOV_NHB = round(NHB_flow * p_SOV_NHB),
	         n_HOV_NHB = round(NHB_flow * p_HOV_NHB),
	         n_walk_NHB = round(NHB_flow * p_walk_NHB),
	         n_bike_NHB = round(NHB_flow * p_bike_NHB)) %>%
	  replace_na(list(n_transit_NHB = 0,
	                  n_SOV_NHB = 0,
	                  n_HOV_NHB = 0,
	                  n_walk_NHB = 0,
	                  n_bike_NHB =0)) 
```
	

### Calculate regional mode shares and compare to regional data
	
```{r}
	alt_modeled_mode_by_purpose_1 <- tibble(
	  purpose = "NHB_model_alt 1", 
	  pct_bike = sum(alt_skims$n_bike_NHB) / 
	                 sum(alt_skims$NHB_flow),
	  pct_SOV = sum(alt_skims$n_SOV_NHB) / 
	                sum(alt_skims$NHB_flow),
	  pct_HOV = sum(alt_skims$n_HOV_NHB) / 
	                sum(alt_skims$NHB_flow),
	  pct_transit = sum(alt_skims$n_transit_NHB) / 
	                sum(alt_skims$NHB_flow),
	  pct_walk = sum(alt_skims$n_walk_NHB) / 
	                sum(alt_skims$NHB_flow))
	
	model_compare <- rbind(mode_by_purpose, alt_modeled_mode_by_purpose_1) 
	
	model_compare
```
	

	Our model overestimates driving alone by 0.1 percentage points, HOV by 15.7 percentage points, underestimates transit by 2 percentage points, underestimates walking by 12 percentage points, and underestimates biking by 2 percentage points.
	

### Calibrate Model (NHB)
	

	Model 1 Constants: 
	transit_const_NHB  <- -0.1
	SOV_const_NHB <- -0.5
	HOV_const_NHB <- -2.5
	bike_const_NHB <- -1.1
	walk_const_NHB <- 5
	

```{r}
	transit_const_NHB  <- 0.7
	SOV_const_NHB <- 0
	HOV_const_NHB <- 0.4
	bike_const_NHB <- -2
	walk_const_NHB <- 1
	
	alt_skims <- alt_skims %>%
	  mutate(utility_transit_NHB = transit_const_NHB +
	                               ride_time * -0.013  +
	                               (access_time + 
	                                 egress_time +
	                                 wait_time +
	                                 transfer_time) * -0.050 +
	                               transit_cost * -0.002,
	         utility_SOV_NHB = SOV_const_NHB +
	                           car_time * -0.013 +
	                           drive_cost * -0.002,
	         utility_HOV_NHB = HOV_const_NHB +
	                           car_time * -0.013 +
	                           carpool_cost * -0.002,
	         utility_walk_NHB = walk_const_NHB +
	                            walk_time * -0.032,
	         utility_bike_NHB = bike_const_NHB +
	                            bike_time * -0.032) %>%
	  mutate(exp_u_walk_NHB = exp(utility_walk_NHB),
	         exp_u_bike_NHB = exp(utility_bike_NHB),
	         exp_u_SOV_NHB = exp(utility_SOV_NHB),
	         exp_u_HOV_NHB = exp(utility_HOV_NHB),
	         exp_u_transit_NHB = exp(utility_transit_NHB)) %>%
	  rowwise() %>%
	  mutate(utility_active_NHB = log(sum(exp_u_walk_NHB, 
	                                          exp_u_bike_NHB, 
	                                          na.rm = TRUE)),
	         utility_car_NHB = log(sum(exp_u_SOV_NHB,
	                                       exp_u_HOV_NHB,
	                                       na.rm = TRUE))) %>%
	  mutate(exp_u_active_NHB = exp(utility_active_NHB),
	         exp_u_car_NHB = exp(utility_car_NHB)) %>%
	  mutate(total_utility_NHB = sum(exp_u_active_NHB, 
	                                 exp_u_car_NHB,
	                                 exp_u_transit_NHB,
	                                 na.rm = TRUE)) %>%
	  ungroup()  %>%
	  mutate(p_transit_NHB = exp(utility_transit_NHB) / total_utility_NHB,
	         p_car_NHB = exp(utility_car_NHB) / total_utility_NHB,
	         p_active_NHB = exp(utility_active_NHB) / total_utility_NHB)  %>%
	  mutate(p_SOV_if_car_NHB = exp(utility_SOV_NHB) / exp(utility_car_NHB),
	         p_HOV_if_car_NHB = exp(utility_HOV_NHB) / exp(utility_car_NHB),
	         p_walk_if_active_NHB = exp(utility_walk_NHB) / exp(utility_active_NHB),
	         p_bike_if_active_NHB = exp(utility_bike_NHB) / exp(utility_active_NHB)) %>%
	  mutate(p_SOV_NHB = p_SOV_if_car_NHB * p_car_NHB,
	         p_HOV_NHB = p_HOV_if_car_NHB * p_car_NHB,
	         p_walk_NHB = p_walk_if_active_NHB * p_active_NHB,
	         p_bike_NHB = p_bike_if_active_NHB * p_active_NHB) %>%
	  mutate(n_transit_NHB = round(NHB_flow * p_transit_NHB),
	         n_SOV_NHB = round(NHB_flow * p_SOV_NHB),
	         n_HOV_NHB = round(NHB_flow * p_HOV_NHB),
	         n_walk_NHB = round(NHB_flow * p_walk_NHB),
	         n_bike_NHB = round(NHB_flow * p_bike_NHB)) %>%
	  replace_na(list(n_transit_NHB = 0,
	                  n_SOV_NHB = 0,
	                  n_HOV_NHB = 0,
	                  n_walk_NHB = 0,
	                  n_bike_NHB =0)) 
```
	

	Let's compare again!
	

```{r}
	alt_modeled_mode_by_purpose_2 <- tibble(
	  purpose = "NHB_model_alt 2", 
	  pct_bike = sum(alt_skims$n_bike_NHB) / 
	                 sum(alt_skims$NHB_flow),
	  pct_SOV = sum(alt_skims$n_SOV_NHB) / 
	                sum(alt_skims$NHB_flow),
	  pct_HOV = sum(alt_skims$n_HOV_NHB) / 
	                sum(alt_skims$NHB_flow),
	  pct_transit = sum(alt_skims$n_transit_NHB) / 
	                sum(alt_skims$NHB_flow),
	  pct_walk = sum(alt_skims$n_walk_NHB) / 
	                sum(alt_skims$NHB_flow))
	
	model_compare2 <- rbind(model_compare, alt_modeled_mode_by_purpose_2) 
	
	model_compare2
```

