---
title: "Assignment10"
author: "Arnav Murulidhar"
date: "4/11/2022"
output: html_document
---

# Load Libraries

```{r}
options(java.parameters = "-Xmx2G")

library(here)
library(tidyverse)
library(stplanr)
library(r5r)
library(sf)
```

#Load skims files

```{r}
skims <- here("existing",
                     "data",
                     "ex_skims_update.csv") %>%
  read_csv(show_col_types = FALSE) %>%
  select(fromId, 
         toId, 
         n_transit_HBO,
         n_SOV_HBO,
         n_HOV_HBO,
         n_walk_HBO,
         n_bike_HBO,
         n_transit_HBW,
         n_SOV_HBW,
         n_HOV_HBW,
         n_walk_HBW,
         n_bike_HBW,
         n_transit_NHB,
         n_SOV_NHB,
         n_HOV_NHB,
         n_walk_NHB,
         n_bike_NHB,
         routes) %>%
  mutate(fromId = as.character(fromId),
         toId = as.character(toId))

alt_skims <- here("alternative",
                     "data",
                     "alt_skims_update.csv") %>%
  read_csv(show_col_types = FALSE) %>%
  select(fromId, 
         toId, 
         n_transit_HBO,
         n_SOV_HBO,
         n_HOV_HBO,
         n_walk_HBO,
         n_bike_HBO,
         n_transit_HBW,
         n_SOV_HBW,
         n_HOV_HBW,
         n_walk_HBW,
         n_bike_HBW,
         n_transit_NHB,
         n_SOV_NHB,
         n_HOV_NHB,
         n_walk_NHB,
         n_bike_NHB,
         routes) %>%
  mutate(fromId = as.character(fromId),
         toId = as.character(toId))
```

########### EXISTING CONDITIONS ########### 

### HBO ###

#Convert HBO PA matrix to OD matrix

```{r}
HBO_PA_mat <- skims %>%
  od_to_odmatrix(attrib = "n_transit_HBO", 
                 name_orig = "fromId",
                 name_dest = "toId") 

HBO_PA_mat <- HBO_PA_mat[,row.names(HBO_PA_mat)]
```

#Transpose HBO Matrix

```{r}
HBO_PA_mat_trans <- t(HBO_PA_mat)
```

#Average HBO matrix w transpose
```{r}
HBO_OD_mat <- (HBO_PA_mat + HBO_PA_mat_trans) / 2
```

#Convert matrix to data frame 
```{r}
HBO_OD_table <- HBO_OD_mat %>%
  odmatrix_to_od() %>%
  rename(fromId = orig,
         toId = dest) %>%
  left_join(skims) %>%
  select(-n_transit_HBO)
```
#Count trips using each HBO route
```{r}
HBO_route_trips <- HBO_OD_table %>%
  filter(flow > 0 & !is.na(routes)) %>%
  mutate(route_1 = str_split_fixed(routes, "\\|", 3)[,1],
         route_2 = str_split_fixed(routes, "\\|", 3)[,2],
         route_3 = str_split_fixed(routes, "\\|", 3)[,3]) %>%
  pivot_longer(cols = c(route_1, route_2, route_3),
               values_to = "route") %>%
  filter(route != "") %>%
  select(route, flow) %>%
  group_by(route) %>%
  summarize(ridership = round(sum(flow)))
```

### HBW ###

#Convert HBW PA matrix to OD matrix

```{r}
HBW_PA_mat <- skims %>%
  od_to_odmatrix(attrib = "n_transit_HBW", 
                 name_orig = "fromId",
                 name_dest = "toId") 

HBW_PA_mat <- HBW_PA_mat[,row.names(HBW_PA_mat)]
```

#Transpose HBW Matrix

```{r}
HBW_PA_mat_trans <- t(HBW_PA_mat)
```

#Average HBW matrix w transpose
```{r}
HBW_OD_mat <- (HBW_PA_mat + HBW_PA_mat_trans) / 2
```

#Convert matrix to data frame 
```{r}
HBW_OD_table <- HBW_OD_mat %>%
  odmatrix_to_od() %>%
  rename(fromId = orig,
         toId = dest) %>%
  left_join(skims) %>%
  select(-n_transit_HBW)
```
#Count trips using each HBW route
```{r}
HBW_route_trips <- HBW_OD_table %>%
  filter(flow > 0 & !is.na(routes)) %>%
  mutate(route_1 = str_split_fixed(routes, "\\|", 3)[,1],
         route_2 = str_split_fixed(routes, "\\|", 3)[,2],
         route_3 = str_split_fixed(routes, "\\|", 3)[,3]) %>%
  pivot_longer(cols = c(route_1, route_2, route_3),
               values_to = "route") %>%
  filter(route != "") %>%
  select(route, flow) %>%
  group_by(route) %>%
  summarize(ridership = round(sum(flow)))
```

### NHB ###

#Convert NHB PA matrix to OD matrix

```{r}
NHB_PA_mat <- skims %>%
  od_to_odmatrix(attrib = "n_transit_NHB", 
                 name_orig = "fromId",
                 name_dest = "toId") 

NHB_PA_mat <- NHB_PA_mat[,row.names(NHB_PA_mat)]
```

#Transpose NHB Matrix

```{r}
NHB_PA_mat_trans <- t(NHB_PA_mat)
```

#Average NHB matrix w transpose
```{r}
NHB_OD_mat <- (NHB_PA_mat + NHB_PA_mat_trans) / 2
```

#Convert matrix to data frame 
```{r}
NHB_OD_table <- NHB_OD_mat %>%
  odmatrix_to_od() %>%
  rename(fromId = orig,
         toId = dest) %>%
  left_join(skims) %>%
  select(-n_transit_NHB)
```
#Count trips using each NHB route
```{r}
NHB_route_trips <- NHB_OD_table %>%
  filter(flow > 0 & !is.na(routes)) %>%
  mutate(route_1 = str_split_fixed(routes, "\\|", 3)[,1],
         route_2 = str_split_fixed(routes, "\\|", 3)[,2],
         route_3 = str_split_fixed(routes, "\\|", 3)[,3]) %>%
  pivot_longer(cols = c(route_1, route_2, route_3),
               values_to = "route") %>%
  filter(route != "") %>%
  select(route, flow) %>%
  group_by(route) %>%
  summarize(ridership = round(sum(flow)))
```

#Calculate total transit ridership by route
```{r}
#Load ridership of all different trip purposes
TOT_route_trips = merge(x=HBW_route_trips,y=HBO_route_trips,by="route",all=TRUE)
TOT_route_trips = merge(x=TOT_route_trips,y=NHB_route_trips,by="route",all=TRUE)

#Replace NA with 0
TOT_route_trips[is.na(TOT_route_trips)] = 0

#Calculate total ridership for each route
TOT_route_trips$total_trips = rowSums(TOT_route_trips[,2:4])
```

# Calculate trip distances
```{r}
centroids <- here("zones",
                   "centroids.geojson") %>%
  st_read()%>%
  filter(!st_is_empty(.)) 

origins <- centroids %>% 
  slice(rep(1:n(), each = n())) %>% 
  mutate(dest_order = 
           rep(seq(1:length(centroids$id)),
               length(centroids$id)))

destinations <- origins %>%
  arrange(dest_order)

r5r_core_existing <- here("existing",
                          "networks") %>%
  setup_r5(verbose = FALSE)

ped_dist <- detailed_itineraries(r5r_core_existing,
                                 origins = origins,
                                 destinations = destinations,
                                 mode = "WALK",
                                 verbose = FALSE)  %>%
  mutate(miles = distance / 1609.34) %>%
  select(fromId, toId, miles) %>%
  st_drop_geometry()

drive_dist <- detailed_itineraries(r5r_core_existing,
                                 origins = origins,
                                 destinations = destinations,
                                 mode = "CAR",
                                 verbose = FALSE) %>%
  mutate(miles = distance / 1609.34) %>%
  select(fromId, toId, miles) %>%
  st_drop_geometry()

bike_dist <- detailed_itineraries(r5r_core_existing,
                                 origins = origins,
                                 destinations = destinations,
                                 mode = "BICYCLE",
                                 verbose = FALSE) %>%
  mutate(miles = distance / 1609.34) %>%
  select(fromId, toId, miles) %>%
  st_drop_geometry()

stop_r5() 

```

###HBO###

#Calculate PMT by Car for HBO trips
```{r}
HBO_PMT_car <- skims %>%
  left_join(drive_dist, by = c("fromId", "toId")) %>%
  select(n_SOV_HBO, n_HOV_HBO, miles) %>%
  mutate(PMT_SOV_HBO = n_SOV_HBO * miles,
         PMT_HOV_HBO = n_HOV_HBO * miles) %>%
  summarize(total_SOV_miles = sum(PMT_SOV_HBO),
            total_HOV_miles = sum(PMT_HOV_HBO))

HBO_PMT_car
```

#Calculate VMT for HBO trips
```{r}
HBO_VMT <- HBO_PMT_car$total_SOV_miles[1] + 
       HBO_PMT_car$total_HOV_miles[1] / 2.71

HBO_VMT
```

#Calculate PMT by Bike for HBO trips
```{r}
HBO_PMT_bike <- skims %>%
  left_join(bike_dist, by = c("fromId", "toId")) %>%
  select(n_bike_HBO, miles) %>%
  mutate(PMT_bike_HBO = n_bike_HBO * miles) %>%
  summarize(total_bike_miles = sum(PMT_bike_HBO))

HBO_PMT_bike
```

#Calculate PMT by Walk for HBO trips
```{r}
HBO_PMT_walk <- skims %>%
  left_join(ped_dist, by = c("fromId", "toId")) %>%
  select(n_walk_HBO, miles) %>%
  mutate(PMT_walk_HBO = n_walk_HBO * miles) %>%
  summarize(total_walk_miles = sum(PMT_walk_HBO))

HBO_PMT_walk
```

### HBW ###
#Calculate PMT by Car for HBW trips
```{r}
HBW_PMT_car <- skims %>%
  left_join(drive_dist, by = c("fromId", "toId")) %>%
  select(n_SOV_HBW, n_HOV_HBW, miles) %>%
  mutate(PMT_SOV_HBW = n_SOV_HBW * miles,
         PMT_HOV_HBW = n_HOV_HBW * miles) %>%
  summarize(total_SOV_miles = sum(PMT_SOV_HBW),
            total_HOV_miles = sum(PMT_HOV_HBW))

HBW_PMT_car
```

#Calculate VMT for HBW trips
```{r}
HBW_VMT <- HBW_PMT_car$total_SOV_miles[1] + 
       HBW_PMT_car$total_HOV_miles[1] / 2.71

HBW_VMT
```

#Calculate PMT by Bike for HBW trips
```{r}
HBW_PMT_bike <- skims %>%
  left_join(bike_dist, by = c("fromId", "toId")) %>%
  select(n_bike_HBW, miles) %>%
  mutate(PMT_bike_HBW = n_bike_HBW * miles) %>%
  summarize(total_bike_miles = sum(PMT_bike_HBW))

HBW_PMT_bike
```

#Calculate PMT by Walk for HBW trips
```{r}
HBW_PMT_walk <- skims %>%
  left_join(ped_dist, by = c("fromId", "toId")) %>%
  select(n_walk_HBW, miles) %>%
  mutate(PMT_walk_HBW = n_walk_HBW * miles) %>%
  summarize(total_walk_miles = sum(PMT_walk_HBW))

HBW_PMT_walk
```

### NHB ###
#Calculate PMT by Car for NHB trips
```{r}
NHB_PMT_car <- skims %>%
  left_join(drive_dist, by = c("fromId", "toId")) %>%
  select(n_SOV_NHB, n_HOV_NHB, miles) %>%
  mutate(PMT_SOV_NHB = n_SOV_NHB * miles,
         PMT_HOV_NHB = n_HOV_NHB * miles) %>%
  summarize(total_SOV_miles = sum(PMT_SOV_NHB),
            total_HOV_miles = sum(PMT_HOV_NHB))

NHB_PMT_car
```

#Calculate VMT for NHB trips
```{r}
NHB_VMT <- NHB_PMT_car$total_SOV_miles[1] + 
       NHB_PMT_car$total_HOV_miles[1] / 2.71

NHB_VMT
```

#Calculate PMT by Bike for NHB trips
```{r}
NHB_PMT_bike <- skims %>%
  left_join(bike_dist, by = c("fromId", "toId")) %>%
  select(n_bike_NHB, miles) %>%
  mutate(PMT_bike_NHB = n_bike_NHB * miles) %>%
  summarize(total_bike_miles = sum(PMT_bike_NHB))

NHB_PMT_bike
```

#Calculate PMT by Walk for NHB trips
```{r}
NHB_PMT_walk <- skims %>%
  left_join(ped_dist, by = c("fromId", "toId")) %>%
  select(n_walk_NHB, miles) %>%
  mutate(PMT_walk_NHB = n_walk_NHB * miles) %>%
  summarize(total_walk_miles = sum(PMT_walk_NHB))

NHB_PMT_walk
```

########### ALTERNATIVE CONDITIONS ########### 

### HBO ###

#Convert HBO PA matrix to OD matrix

```{r}
HBO_PA_mat <- skims %>%
  od_to_odmatrix(attrib = "n_transit_HBO", 
                 name_orig = "fromId",
                 name_dest = "toId") 

HBO_PA_mat <- HBO_PA_mat[,row.names(HBO_PA_mat)]
```

#Transpose HBO Matrix

```{r}
HBO_PA_mat_trans <- t(HBO_PA_mat)
```

#Average HBO matrix w transpose
```{r}
HBO_OD_mat <- (HBO_PA_mat + HBO_PA_mat_trans) / 2
```

#Convert matrix to data frame 
```{r}
HBO_OD_table <- HBO_OD_mat %>%
  odmatrix_to_od() %>%
  rename(fromId = orig,
         toId = dest) %>%
  left_join(skims) %>%
  select(-n_transit_HBO)
```
#Count trips using each HBO route
```{r}
HBO_route_trips <- HBO_OD_table %>%
  filter(flow > 0 & !is.na(routes)) %>%
  mutate(route_1 = str_split_fixed(routes, "\\|", 3)[,1],
         route_2 = str_split_fixed(routes, "\\|", 3)[,2],
         route_3 = str_split_fixed(routes, "\\|", 3)[,3]) %>%
  pivot_longer(cols = c(route_1, route_2, route_3),
               values_to = "route") %>%
  filter(route != "") %>%
  select(route, flow) %>%
  group_by(route) %>%
  summarize(ridership = round(sum(flow)))
```

### HBW ###

#Convert HBW PA matrix to OD matrix

```{r}
HBW_PA_mat <- skims %>%
  od_to_odmatrix(attrib = "n_transit_HBW", 
                 name_orig = "fromId",
                 name_dest = "toId") 

HBW_PA_mat <- HBW_PA_mat[,row.names(HBW_PA_mat)]
```

#Transpose HBW Matrix

```{r}
HBW_PA_mat_trans <- t(HBW_PA_mat)
```

#Average HBW matrix w transpose
```{r}
HBW_OD_mat <- (HBW_PA_mat + HBW_PA_mat_trans) / 2
```

#Convert matrix to data frame 
```{r}
HBW_OD_table <- HBW_OD_mat %>%
  odmatrix_to_od() %>%
  rename(fromId = orig,
         toId = dest) %>%
  left_join(skims) %>%
  select(-n_transit_HBW)
```
#Count trips using each HBW route
```{r}
HBW_route_trips <- HBW_OD_table %>%
  filter(flow > 0 & !is.na(routes)) %>%
  mutate(route_1 = str_split_fixed(routes, "\\|", 3)[,1],
         route_2 = str_split_fixed(routes, "\\|", 3)[,2],
         route_3 = str_split_fixed(routes, "\\|", 3)[,3]) %>%
  pivot_longer(cols = c(route_1, route_2, route_3),
               values_to = "route") %>%
  filter(route != "") %>%
  select(route, flow) %>%
  group_by(route) %>%
  summarize(ridership = round(sum(flow)))
```

### NHB ###

#Convert NHB PA matrix to OD matrix

```{r}
NHB_PA_mat <- skims %>%
  od_to_odmatrix(attrib = "n_transit_NHB", 
                 name_orig = "fromId",
                 name_dest = "toId") 

NHB_PA_mat <- NHB_PA_mat[,row.names(NHB_PA_mat)]
```

#Transpose NHB Matrix

```{r}
NHB_PA_mat_trans <- t(NHB_PA_mat)
```

#Average NHB matrix w transpose
```{r}
NHB_OD_mat <- (NHB_PA_mat + NHB_PA_mat_trans) / 2
```

#Convert matrix to data frame 
```{r}
NHB_OD_table <- NHB_OD_mat %>%
  odmatrix_to_od() %>%
  rename(fromId = orig,
         toId = dest) %>%
  left_join(skims) %>%
  select(-n_transit_NHB)
```
#Count trips using each NHB route
```{r}
NHB_route_trips <- NHB_OD_table %>%
  filter(flow > 0 & !is.na(routes)) %>%
  mutate(route_1 = str_split_fixed(routes, "\\|", 3)[,1],
         route_2 = str_split_fixed(routes, "\\|", 3)[,2],
         route_3 = str_split_fixed(routes, "\\|", 3)[,3]) %>%
  pivot_longer(cols = c(route_1, route_2, route_3),
               values_to = "route") %>%
  filter(route != "") %>%
  select(route, flow) %>%
  group_by(route) %>%
  summarize(ridership = round(sum(flow)))
```

#Calculate total transit ridership by route
```{r}
#Load ridership of all different trip purposes
TOT_route_trips = merge(x=HBW_route_trips,y=HBO_route_trips,by="route",all=TRUE)
TOT_route_trips = merge(x=TOT_route_trips,y=NHB_route_trips,by="route",all=TRUE)

#Replace NA with 0
TOT_route_trips[is.na(TOT_route_trips)] = 0

#Calculate total ridership for each route
TOT_route_trips$total_trips = rowSums(TOT_route_trips[,2:4])
```

# Calculate trip distances
```{r}
centroids <- here("zones",
                   "centroids.geojson") %>%
  st_read()%>%
  filter(!st_is_empty(.)) 

origins <- centroids %>% 
  slice(rep(1:n(), each = n())) %>% 
  mutate(dest_order = 
           rep(seq(1:length(centroids$id)),
               length(centroids$id)))

destinations <- origins %>%
  arrange(dest_order)

r5r_core_existing <- here("existing",
                          "networks") %>%
  setup_r5(verbose = FALSE)

ped_dist <- detailed_itineraries(r5r_core_existing,
                                 origins = origins,
                                 destinations = destinations,
                                 mode = "WALK",
                                 verbose = FALSE)  %>%
  mutate(miles = distance / 1609.34) %>%
  select(fromId, toId, miles) %>%
  st_drop_geometry()

drive_dist <- detailed_itineraries(r5r_core_existing,
                                 origins = origins,
                                 destinations = destinations,
                                 mode = "CAR",
                                 verbose = FALSE) %>%
  mutate(miles = distance / 1609.34) %>%
  select(fromId, toId, miles) %>%
  st_drop_geometry()

bike_dist <- detailed_itineraries(r5r_core_existing,
                                 origins = origins,
                                 destinations = destinations,
                                 mode = "BICYCLE",
                                 verbose = FALSE) %>%
  mutate(miles = distance / 1609.34) %>%
  select(fromId, toId, miles) %>%
  st_drop_geometry()

stop_r5() 

```

###HBO###

#Calculate PMT by Car for HBO trips
```{r}
HBO_PMT_car <- skims %>%
  left_join(drive_dist, by = c("fromId", "toId")) %>%
  select(n_SOV_HBO, n_HOV_HBO, miles) %>%
  mutate(PMT_SOV_HBO = n_SOV_HBO * miles,
         PMT_HOV_HBO = n_HOV_HBO * miles) %>%
  summarize(total_SOV_miles = sum(PMT_SOV_HBO),
            total_HOV_miles = sum(PMT_HOV_HBO))

HBO_PMT_car
```

#Calculate VMT for HBO trips
```{r}
HBO_VMT <- HBO_PMT_car$total_SOV_miles[1] + 
       HBO_PMT_car$total_HOV_miles[1] / 2.71

HBO_VMT
```

#Calculate PMT by Bike for HBO trips
```{r}
HBO_PMT_bike <- skims %>%
  left_join(bike_dist, by = c("fromId", "toId")) %>%
  select(n_bike_HBO, miles) %>%
  mutate(PMT_bike_HBO = n_bike_HBO * miles) %>%
  summarize(total_bike_miles = sum(PMT_bike_HBO))

HBO_PMT_bike
```

#Calculate PMT by Walk for HBO trips
```{r}
HBO_PMT_walk <- skims %>%
  left_join(ped_dist, by = c("fromId", "toId")) %>%
  select(n_walk_HBO, miles) %>%
  mutate(PMT_walk_HBO = n_walk_HBO * miles) %>%
  summarize(total_walk_miles = sum(PMT_walk_HBO))

HBO_PMT_walk
```

### HBW ###
#Calculate PMT by Car for HBW trips
```{r}
HBW_PMT_car <- skims %>%
  left_join(drive_dist, by = c("fromId", "toId")) %>%
  select(n_SOV_HBW, n_HOV_HBW, miles) %>%
  mutate(PMT_SOV_HBW = n_SOV_HBW * miles,
         PMT_HOV_HBW = n_HOV_HBW * miles) %>%
  summarize(total_SOV_miles = sum(PMT_SOV_HBW),
            total_HOV_miles = sum(PMT_HOV_HBW))

HBW_PMT_car
```

#Calculate VMT for HBW trips
```{r}
HBW_VMT <- HBW_PMT_car$total_SOV_miles[1] + 
       HBW_PMT_car$total_HOV_miles[1] / 2.71

HBW_VMT
```

#Calculate PMT by Bike for HBW trips
```{r}
HBW_PMT_bike <- skims %>%
  left_join(bike_dist, by = c("fromId", "toId")) %>%
  select(n_bike_HBW, miles) %>%
  mutate(PMT_bike_HBW = n_bike_HBW * miles) %>%
  summarize(total_bike_miles = sum(PMT_bike_HBW))

HBW_PMT_bike
```

#Calculate PMT by Walk for HBW trips
```{r}
HBW_PMT_walk <- skims %>%
  left_join(ped_dist, by = c("fromId", "toId")) %>%
  select(n_walk_HBW, miles) %>%
  mutate(PMT_walk_HBW = n_walk_HBW * miles) %>%
  summarize(total_walk_miles = sum(PMT_walk_HBW))

HBW_PMT_walk
```

### NHB ###
#Calculate PMT by Car for NHB trips
```{r}
NHB_PMT_car <- skims %>%
  left_join(drive_dist, by = c("fromId", "toId")) %>%
  select(n_SOV_NHB, n_HOV_NHB, miles) %>%
  mutate(PMT_SOV_NHB = n_SOV_NHB * miles,
         PMT_HOV_NHB = n_HOV_NHB * miles) %>%
  summarize(total_SOV_miles = sum(PMT_SOV_NHB),
            total_HOV_miles = sum(PMT_HOV_NHB))

NHB_PMT_car
```

#Calculate VMT for NHB trips
```{r}
NHB_VMT <- NHB_PMT_car$total_SOV_miles[1] + 
       NHB_PMT_car$total_HOV_miles[1] / 2.71

NHB_VMT
```

#Calculate PMT by Bike for NHB trips
```{r}
NHB_PMT_bike <- skims %>%
  left_join(bike_dist, by = c("fromId", "toId")) %>%
  select(n_bike_NHB, miles) %>%
  mutate(PMT_bike_NHB = n_bike_NHB * miles) %>%
  summarize(total_bike_miles = sum(PMT_bike_NHB))

NHB_PMT_bike
```

#Calculate PMT by Walk for NHB trips
```{r}
NHB_PMT_walk <- skims %>%
  left_join(ped_dist, by = c("fromId", "toId")) %>%
  select(n_walk_NHB, miles) %>%
  mutate(PMT_walk_NHB = n_walk_NHB * miles) %>%
  summarize(total_walk_miles = sum(PMT_walk_NHB))

NHB_PMT_walk
```
