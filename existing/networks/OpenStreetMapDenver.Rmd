---
title: "OpenStreetMap"
author: "Miguel Perez Luna"
date: "2/17/2022"
output: html_document
---
```{r}
library(sf)
library(tigris)
library(tidyverse)
library(osmdata)
library(here)
library(tidytransit)

```

# Downloading the OpenStreetMap Network for the Denver MSA

```{r}
# Load the MSA boundaries
boundary <- core_based_statistical_areas() %>%
  filter(GEOID == "19740")

# Define a bounding box containing the MSA
denver_bbox <- st_bbox(boundary)

q <- opq(bbox = denver_bbox) %>% # create a query
  add_osm_feature(key = 'highway') %>% # request only road data
  osmdata_xml(file = here("existing/networks/streets.osm")) # download osm file
```

# Convert the OSM file to a PBF file

We did this using Homebrew, in the Mac Terminal, and with Arnav's help.

# Downloading GTFS Data

We used tidytransit and view(feedlist) to find the url for the Denver GTFS data.

# Installing 

# Creating Zone centroids


```{r}
centroids <- here("zones",
                  "boundaries1.geojson") %>%
  
  st_read() %>%
  st_centroid() %>%
  st_transform("WGS84") %>%
  rename(id = GEOID)
```


# Adding memory for Java

```{r}
options(java.parameters = "-Xmx4G")

library(r5r)
```

# Alternative Core

```{r}
alternative_core <- here("existing",
                      "networks") %>%
  setup_r5(verbose = FALSE)
```

# Generating Skims

## Driving Skims

```{r}
car_skim <- travel_time_matrix(alternative_core,
                               origins = centroids,
                               destinations = centroids,
                               mode = "CAR")
```

## Walking Skims

```{r}
walk_skim <- travel_time_matrix(alternative_core,
                               origins = centroids,
                               destinations = centroids,
                               mode = "WALK")
```

## Bicycle Skims

```{r}
bicycle_skim <- travel_time_matrix(alternative_core,
                               origins = centroids,
                               destinations = centroids,
                               mode = "BICYCLE")
```

## Transit Skims

```{r}
library(lubridate)

transit_skim <- travel_time_matrix(alternative_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "TRANSIT",
                     departure_datetime = ymd_hm("2021-12-04 17:00"),
                     breakdown = TRUE)
```

We ran stop_r5() after many failed attempts at running a skim, thinking mabybe there was a backlog of skims which was maybe impacting memory space, but that didn't help. We didn't run it before trying a skim a second time. 

```{r}
stop_r5()
```

``` {r}
transit_skim_alt <- transit_skim_alt %>%
  filter(n_rides > 0)
```

